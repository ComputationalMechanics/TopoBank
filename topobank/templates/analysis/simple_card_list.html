{# Needs some keys in context. See AJAX view "SimpleCardView" #}
{% load analysis_tags %}
{% load fontawesome %}

<div class="card">
    <div class="card-header">
      {% if analyses_available %}
      <div class="btn-group btn-group-sm pull-right dropdown">

        <button type="button" class="btn btn-default" data-toggle="dropdown"
                aria-haspopup="true" aria-expanded="false">
          <i class="fa fa-chevron-down"></i>
        </button>
        <div class="dropdown-menu dropdown-menu-right">
          <a class="dropdown-item" href="#" data-toggle="modal"
             data-target="#statusesModal-{{ idx }}">Task information</a>
        </div>
      </div>
      {% endif %}
      <h4>{{ title }}</h4>
    </div>
    <div class="card-body">
      <ul class="nav nav-tabs">
        <li class="nav-item" style="list-style-type: none;">
          <a class="nav-link active" data-toggle="tab" href="#raw-{{ idx }}">Raw Results</a>
        </li>
        {% if analyses_failure %}
        <li class="nav-item" style="list-style-type: none;">
          <a class="nav-link" data-toggle="tab" href="#failures-{{ idx }}">Failures</a>
        </li>
        {% endif %}
      </ul>

      <div class="tab-content">
        <div class="tab-pane fade show active" id="plot-{{ idx }}" role="tabpanel" aria-labelledby="card-tab">
          {% for af in analyses_failure %}
            <div class="alert alert-warning">
              {% fontawesome_icon 'exclamation-circle' %}
              Analysis for topography <em>{{ au.topography.name }}</em> failed.
              See tab "Failures" for details.
            </div>
          {% endfor %}
          {% for au in analyses_unready %}
            <div class="alert alert-info">
              <div class="spinner"></div>
              Analysis for topography <em>{{ au.topography.name }}</em> not avaliable yet. Please wait..
            </div>
          {% endfor %}
          {% for mt in topographies_missing %}
            <div class="alert alert-warning">
              Analysis for topography <em>{{ mt.name }}</em> not triggered yet. Please trigger if needed.
              {# TODO Provide link to trigger analysis #}
            </div>
          {% endfor %}
          {% if analyses_success %}
           {# Show all analyses for which we have results #}
           <table class="table table-striped">
             <thead>
              <th>Topography</th>
              <th>Result</th>
             </thead>
             <tbody>
              {% for a in analyses_success %}
              <tr>
                <td>{{ a.topography.name }}</td>
                <td><details><pre>{{ a.result_obj }}</pre></details></td>
              </tr>
              {% endfor %}
             </tbody>
           </table>
          {% endif %}
        </div>
        {% if analyses_failure %}
        <div class="tab-pane fade" id="failures-{{ idx }}" role="tabpanel" aria-labelledby="failures-tab">
          {% for af in analyses_failure %}
            <div class="alert alert-warning">
              <p>Analysis failed for topography
                 <a href="{% url 'manager:topography-detail' af.topography.id %}">{{ af.topography.name }}</a>.
                Traceback:</p>
              <pre>{{ af.result_obj.error }}</pre>
            </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
    </div>
</div>

<div class="modal fade" id="statusesModal-{{ idx }}" tabindex="-1" role="dialog"
     aria-labelledby="statusesModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="statusesModalLabel">Tasks</h5>
        <button class="close" type="button" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">Ã—</span>
        </button>
      </div>
      <div class="modal-body">
        {% if analyses_available %}
        <small>
          <table class="table table-hover">
            <thead>
            <tr>
              <th scope="col">Function</th>
              <th scope="col">Topography</th>
              <th scope="col">Further Args</th>
              <th scope="col">Task State</th>
              <th scope="col">Start Time</th>
              <th scope="col">Duration</th>
            </tr>
            </thead>
            <tbody>
            {% for analysis in analyses_available %}
              <tr>
                <td>{{ analysis.function.name }}</td>
                <td>
                  <a
                    href="{% url 'manager:topography-detail' analysis.topography_id %}">{{ analysis.topography.name }}</a>
                </td>
                <td>{{ analysis.get_kwargs_display }}</td>
                <td>{{ analysis.get_task_state_display }}</td>
                <td>{{ analysis.start_time|date:"Y-m-d H:i:s" }}</td>
                <td>{{ analysis.duration|default_if_none:"" }}</td>
              </tr>
            {% endfor %}
            </tbody>

          </table>
        </small>
        {% else %}
          <div class="alert alert-info">
          No analysis triggered for this function and these topographies.
          </div>
        {% endif %}
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
