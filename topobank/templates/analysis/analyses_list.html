{% extends 'base.html' %}
{% load fontawesome %}
{% load crispy_forms_tags %}
{% load analysis_tags %}
{% load static %}

{% block content-title %}
  Analysis Results
{% endblock content-title %}

{% block extra_css %}
  <link href="https://cdn.bokeh.org/bokeh/release/bokeh-1.3.4.min.css"
        rel="stylesheet" type="text/css">
  <link href="https://cdn.bokeh.org/bokeh/release/bokeh-widgets-1.3.4.min.css"
        rel="stylesheet" type="text/css">
  <link href="https://cdn.bokeh.org/bokeh/release/bokeh-tables-1.3.4.min.css"
        rel="stylesheet" type="text/css">
  {{ form.media.css }}

   {# TODO move script tag to end? #}
  <script src="https://unpkg.com/vue@latest"></script>
  <script src="https://unpkg.com/vue-select@latest"></script>
  <link rel="stylesheet" href="https://unpkg.com/vue-select@latest/dist/vue-select.css">

{% endblock extra_css %}

{% block breadcrumbs %}
  <li class="breadcrumb-item active" aria-current="page">Analyses</li>
{% endblock breadcrumbs %}

{% block basket %}
  <!-- Filter for topographies and analysis functions -->
  <div class="bg-light border-top border-bottom">
    <div class="container-fluid">
      <div class="py-2">
        <div id="basket">
          <div v-if="keys.length">
            <basket-element v-for="key in keys" v-bind:elem="get_element(key)" v-bind:key="key"></basket-element>
          </div>
          <span v-else>No items selected yet. In order to select, please use the checkboxes in the Search Results.</span>
        </div>
      </div>

    </div>
  </div>
{% endblock basket %}

{% block content %}

  {% include "tabs.html" with active_tab="analyze" %}

  <div class="tab-content mt-2">
    <div id="analyses" class="tab-pane active">

      {% crispy form form.helper %}

      {# TODO for some reason here also JS code for select2 is inserted too early, this causes warnings #}
      <!--
      Show one card for each analysis function

      Will be replaced by AJAX call.
      -->
      <div class="row">
        {% for card in cards %}
          <div class="col-xl-6 mb-4">

            <div id="card-{{ forloop.counter }}">
              <div class="card search-result-card">
                <div class="card-header">
                  <h5>{{ card.function.name }}</h5>
                </div>
                <div class="card-body">
                    <span class="spinner"></span>
                    <div id="card-{{ forloop.counter }}-wait-text">
                      Please wait
                    </div>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

    </div>
  </div>


{% endblock content %}

{% block javascript %}
  <!-- ----------- for bokeh plot ----- -->
  <script src="https://cdn.bokeh.org/bokeh/release/bokeh-1.3.4.min.js"></script>
  <script src="https://cdn.bokeh.org/bokeh/release/bokeh-widgets-1.3.4.min.js"></script>
  <script src="https://cdn.bokeh.org/bokeh/release/bokeh-tables-1.3.4.min.js"></script>

  <!-- for task progress bar -->
  <script src="{% static 'celery_progress/celery_progress.js' %}"></script>

  <!-- Trigger fetching analysis results -->
  <script>
    // for each card submit ajax call to insert result card
    $(document).ready(function () {
      {% url 'analysis:card' as card_url %}
      {% for card in cards %}
        submit_analyses_card_ajax("{{ card_url }}", "card-{{ forloop.counter }}", "list", {{ card.function.id }}, {{ card.topography_ids_json|safe }}, 0);
      {% endfor %}
    });

    // we don't want error messages if the page is left before everything is loaded
    install_handler_for_aborting_all_ajax_calls_on_page_leave();
  </script>

  <!-- for crispy form -->
  {{ form.media.js }}
{% endblock javascript %}
