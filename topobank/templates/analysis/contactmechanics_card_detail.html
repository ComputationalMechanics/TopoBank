{# Needs some keys in context. See AJAX view "PlotCardView" #}
{% extends 'analysis/simple_card_detail.html' %}
{% load analysis_tags %}
{% load fontawesome %}

{% block card_header %}
  <div class="pull-left">
    <h2>{{ title }}</h2>
  </div>
  <ul class="nav nav-pills card-header-pills pull-right">
    {% if special_values or analyses_failure %}{#  we only need the plot pill if there is anything else #}
    <li class="nav-item">
      <a class="nav-link active" data-toggle="pill" href="#plot" role="tab">Plot</a>
    </li>
    {% endif %}
    {% if special_values %}
    <li class="nav-item" style="list-style-type: none;">
      <a class="nav-link" data-toggle="tab" href="#values">Special values</a>
    </li>
    {% endif %}
    {% if analyses_failure %}
    <li class="nav-item" style="list-style-type: none;">
      {# Use href with card_id because the included HTML uses this too #}
      <a class="nav-link" data-toggle="tab" href="#failures-tab-{{ card_id }}">Failures</a>
    </li>
    {% endif %}
  </ul>
{% endblock card_header %}


{% block card_body %}

  <div class="row">

    <div class="col-9">
      <div class="tab-content">

        <div class="tab-pane fade show active" id="plot" role="tabpanel" aria-labelledby="card-tab">
          {% include 'analysis/analyses_alerts.html' %}
          {% if not analyses_unready and analyses_success %}
            {# Show all analyses for which we have results #}
            {{ contact_area_plot_div | safe }}
          {% endif %}
        </div>
        {% if special_values %}
          <div class="tab-pane fade" id="values" role="tabpanel" aria-labelledby="values-tab">
            <table class="table table-striped table-bordered">
              <thead>
              <tr>
                <th>Topography</th>
                <th>Quantity</th>
                <th>Value</th>
              </tr>
              </thead>
              <tbody>
              {% for topography, quantity, value, unit in special_values %}
                <tr>
                  <td>{{ topography.name }}</td>
                  <td>{{ quantity }}</td>
                  <td>{{ value }} {{ unit }}</td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
        {% include 'analysis/analyses_failure_tab_pane.html' %}
      </div>
    </div>

    <div class="col-3">

      <div class="row p-3">
        <div class="col">
        </div>
      </div>
      <div class="row p-3">
        <div class="col">
          <!-- button area -->
          {% if analyses_available %}
            <!--
            {% if analyses_success %}
              <a class="btn btn-default btn-block btn-lg"
                 href="{% url 'analysis:download-txt' analyses_success|analyses_results_ids_list_str %}">
                {% fontawesome_icon 'download' %} Download as TXT</a>
              <a class="btn btn-default btn-block btn-lg"
                 href="{% url 'analysis:download-xlsx' analyses_success|analyses_results_ids_list_str %}">
                {% fontawesome_icon 'download' %} Download as XLSX</a>
            {% endif %}
            -->
            {% if not analyses_unready %}
              <a class="btn btn-default btn-block btn-lg" href="#" data-toggle="modal"
                 data-target="#statusesModal-{{ card_id }}">{% fontawesome_icon 'tasks' %} Task information</a>
            {% endif %}
          {% endif %}
        </div>
      </div>
      <div class="row p-3">
        <div class="col">
            <a href="{% url 'analysis:list' %}"
               class="btn btn-default btn-block btn-lg">
              {% fontawesome_icon 'list' %} Back to search results
            </a>
        </div>
      </div>
      {% if not analyses_unready %}
      <form>
        <div class="row p-3">
          <div class="col">

            <div class="input-group">
              <label for="substrate-select" class="col-sm-6 col-form-label">
                Type:
              </label>
              <select class="custom-select col-sm-6" id="substrate-select">
                <option value="periodic" selected>Periodic (repeating array of the topography)</option>
                <option value="nonperiodic">Free boundaries (flat punch with topography)</option>
              </select>
            </div>
            <div class="input-group">
              <!-- div class="input-group-prepend">
                <input type="checkbox" aria-label="hardness">
              </div -->
              <!-- div class="input-group-prepend">
                <span class="input-group-text" id="inputGroup-sizing-default">Hardness</span>
              </div -->
              <label for="hardness-input" class="col-sm-6 col-form-label">
                Hardness:
              </label>
              <input id='hardness-input' type="number" min="0" class="col-sm-6 col-form-control"
                     value="{{ initial_calc_kwargs.hardness }}"
                     aria-label="">
            </div>
            <div class="input-group">
              <!-- div class="input-group-prepend">
                <span class="input-group-text" id="inputGroup-sizing-default">Number of steps</span>
              </div -->
              <label for="nsteps-input" class="col-sm-6 col-form-label">
                Number of steps:
              </label>
              <input id='nsteps-input' type="number" min="0" max="50" class="col-sm-6 col-form-control"
                     value="{{ initial_calc_kwargs.nsteps }}"
                     aria-label="">
            </div>
          </div>
        </div>
        <div class="row p-3">
          <div class="col">
            <button type="submit" id="recalculate" class="btn btn-primary btn-block btn-lg">Recalculate</button>
          </div>
        </div>
      </form>
      {% endif %}



    </div>

  </div>
{% endblock card_body %}

{% block card_javascript %}

  {% if not analyses_unready and analyses_success %}
    {# Insert the script code needed for the plot #}
    {{ contact_area_plot_script | safe }}
  {% endif %}

  {# Additonal code for initialization #}
  <script>

  function debug_msg(msg) {
    alert("Debug: "+msg);
    console.log("Debug: "+msg);
  }

  $("#recalculate").click( function() {

       var substrate_str = $('#substrate-select').val();
       var hardness = parseInt($('#hardness-input').val());
       var nsteps = parseInt($('#nsteps-input').val());
       // debug_msg("Clicked button. substrate: "+substrate_str+"hardness: "+hardness+" nsteps: "+nsteps);

       $.ajax({
        type: "POST",
        url: "{% url 'analysis:card-submit' %}",
        timeout: 0,
        data: {
          function_id: {{ function.id }},
          topography_ids: {{ topography_ids_requested_json|safe }},
          function_kwargs_json: JSON.stringify({ 'substrate_str': substrate_str, 'hardness': hardness, 'nsteps': nsteps}),
          csrfmiddlewaretoken: "{{csrf_token}}"
        },
        success : function(data, textStatus, xhr) {
          debug_msg("Job submission successful. Status: "+xhr.status+" textStatus: "+textStatus);
          if (xhr.status==200) {
            console.log("Triggering reload of card");
            submit_analyses_card_ajax("{% url 'analysis:card' %}", "card", "detail", {{ function.id }},
                                      {{ topography_ids_requested_json|safe }});
            debug_msg("Triggered card reload. Status: "+xhr.status+" textStatus: "+textStatus);
          } else {
            console.log("Submitting analyses failed");
            var div = $('#plot'); // show the error in a prominent way
            $(div).html("Triggering calculation failed, status: "+xhr.status+" response:"+xhr.responseText);
            $(div).addClass("alert alert-danger");
          }
        },
        error: function(xhr, textStatus, errorThrown) {
          console.log("AJAX error when submitting jobs: errorThrown: "+errorThrown+" status: " +xhr.status+" responseText: "+xhr.responseText);
          var div = $('#plot'); // show the error in a prominent way
          $(div).html("Please report this error: "+errorThrown+xhr.status+xhr.responseText);
          $(div).addClass("alert alert-danger");
        }
      });

    });

  </script>
{% endblock card_javascript %}
