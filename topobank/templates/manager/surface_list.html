
{% extends 'base.html' %}
{% load fontawesome %}
{% load crispy_forms_tags %}
{% load surface_tags %}
{% load guardian_tags %}
{% load static i18n %}

{% block extra_css %}

  {# gijgo: for having a searchable tree #}


  <link rel="stylesheet" href="https://unpkg.com/gijgo@1.9.13/css/gijgo.min.css">

  {# vuejs for interactivity #}
  {# TODO move script tag to end? #}
  <script src="https://unpkg.com/vue@latest"></script>
  <script src="https://unpkg.com/vue-select@latest"></script>
  <link rel="stylesheet" href="https://unpkg.com/vue-select@latest/dist/vue-select.css">
  {{ form.media.css }}

  <!-- Include Fancytree skin  -->
  <!-- link href="{# static 'vendor/fancytree/skin-awesome/ui.fancytree.min.css' #}" rel="stylesheet" -->
  <!-- TODO Use CDN? -->
  <link href="https://unpkg.com/jquery.fancytree@2.32.0/dist/skin-awesome/ui.fancytree.min.css" rel="stylesheet">

{% endblock extra_css %}

{% block breadcrumbs %}
  <li class="breadcrumb-item active" aria-current="page">
    Surfaces
  </li>
{% endblock breadcrumbs %}

{% block searchbox %}

  <!--

  <div class="bg-light border-top border-bottom">
    <div class="container-fluid">
      {% crispy form form.helper %}
    </div>
  </div>
  -->


{% endblock searchbox %}

{% block content %}

  {# selected items in session #}
  <div class="card">
    <div class="card-header">
      Seleted items
    </div>
    <div class="card-body">
      <div id="basket">
        <div v-if="nodes.length">
          <basket-element v-for="node in nodes" v-bind:node="node" v-bind:key="node.key"></basket-element>
        </div>
        <span v-else>No items selected yet. In order to select, please use the checkboxes in the search result tree.</span>
      </div>
    </div>
  </div>

  {# search box #}
  {# full text search in names, descriptions, labels #}
  <div class="card">
    <div class="card-header">
      Search items
    </div>
    <div class="card-body">
      <form>
        <div class="form-row">

          <div class="form-group col-md-5">
            <div class="input-group">
              <input id="searchbar" type="text" class="form-control" aria-label="Search"
                     placeholder="Filter by name, description, and tags..." autocomplete="off">
              <div class="input-group-append">
                <button class="btn btn-outline-secondary form-control" id="button_reset_filter" type="button">&times;</button>
              </div>
            </div>
          </div>

          <div class="form-group col-md2">
            <select class="form-control" id="select-category-filter">
              <option value="all" selected>All categories</option>
              <option value="exp">Experimental data only</option>
              <option value="sim">Simulated data only</option>
              <option value="dum">Dummy data only</option>
            </select>
          </div>

          <div class="form-group col-md-2">
            <select class="form-control" id="select-sharing-status-filter">
              <option value="all" selected>Own and shared surfaces</option>
              <option value="own">Only own surfaces</option>
              <option value="shared">Only surfaces shared with you</option>
            </select>
          </div>

          <div class="form-group col-md-2">
            <a class="btn btn-primary" href="{% url 'manager:surface-create' %}">Create Surface</a>
          </div>

        </div>

      </form>
      <div id="search-result">

        <div id="scrollParent" style="height: 500px; overflow: auto;">
          <table id="newtree" class="table table-condensed">
            <colgroup>
              <col width="2%"></col>
              <col width="35%"></col>
              <col width="2%"></col>
              <col width="46%"></col>
              <col width="15%"></col>
            </colgroup>
            <thead>
            <tr>
              <th scope="col"></th>
              <th scope="col">Name</th>
              <th scope="col"></th>{# for actions #}
              <th scope="col">Description</th>
              <th scope="col">Tags</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
      </div>

    </div>

    <div class="card-footer">
      <div id="result-summary"></div>
    </div>
  </div>
  </div>

  {# search result as a tree table #}




   <!--
  Show one card for each selected surface

  Will be replaced by AJAX call.
  -->
{#  #}
{#  <div class="row">#}
{#    {% for surface in surfaces %}#}
{#      <div class="col-xl-4 mb-4">#}
{#        <div id="card-{{ surface.id }}">#}
{#          <div class="card">#}
{#            <div class="card-header">#}
{#              <h5>{{ surface.name }}</h5>#}
{#            </div>#}
{#            <div class="card-body">#}
{#              <p>Please wait..</p>#}
{#              <div class="spinner"></div>#}
{#            </div>#}
{#          </div>#}
{#        </div>#}
{#      </div>#}
{#    {% endfor %}#}
{#  </div>#}


{% endblock content %}

{% block javascript %}
  {{ form.media.js }}

  <script src="https://unpkg.com/gijgo@1.9.13/js/gijgo.min.js"></script>

  <script src="https://unpkg.com/jquery-highlight@3.3.0/jquery.highlight.js"></script>
  <script src="https://unpkg.com/jquery.fancytree@2.32.0/dist/jquery.fancytree-all-deps.min.js"></script>
  <script src="https://unpkg.com/jquery.fancytree@2.32.0/dist/modules/jquery.fancytree.glyph.js"></script>
  <script src="https://unpkg.com/jquery.fancytree@2.32.0/dist/modules/jquery.fancytree.table.js"></script>
  <script src="https://unpkg.com/jquery.fancytree@2.32.0/dist/modules/jquery.fancytree.filter.js"></script>
  {#  <script src="{% static 'vendor/jquery-highlight-3.3.0/jquery.highlight.js' %}"></script>#}
  {#  <script src="{% static 'vendor/fancytree/jquery.fancytree-all-deps.min.js' %}"></script>#}
  {#  <script src="{% static 'vendor/fancytree/modules/jquery.fancytree.glyph.js' %}"></script>#}
  {#  <script src="{% static 'vendor/fancytree/modules/jquery.fancytree.table.js' %}"></script>#}
  {#  <script src="{% static 'vendor/fancytree/modules/jquery.fancytree.filter.js' %}"></script>#}



  <script>

      /**
       * Display search results as tree
       * @type {*|jQuery}
       */

      function get_tree() {
          return $("#newtree").fancytree("getTree");
      }

      var basket = new Vue({
          delimiters: ['[[', ']]'],
          el: '#basket',
          data: {
              nodes: [],
          },
          methods:{
              update: function () {
                  var tree = get_tree();
                  var nodes = [];

                  tree.getSelectedNodes(true).forEach(function (node) {
                      // here called with stopOnParents=true,
                      // so selected surfaces are pushed but not single topographies then
                      nodes.push(node);
                  });

                  this.nodes = nodes;
              }
          }
      });

      var summary_vm = new Vue({
          delimiters: ['[[', ']]'],
          el: '#result-summary',
          template: `
            <span>Showing [[ num_surfaces_shown ]] surfaces out of [[ num_surfaces ]].</span>
          `,
          data: {
              num_surfaces: 0,
              num_surfaces_shown: 0
          },
          methods: {
              update: function() {
                  var tree = get_tree();
                  this.num_surfaces = tree.rootNode.children.length;
                  this.num_surfaces_shown = tree.rootNode.children.filter(function (node){
                      return node.isMatched();
                  }).length;
              }
          }
      });

      function menu_items(node, urls) {
          // node: tree node for which this function is called
          // urls: object with url names as keys and urls as values
          //
          // Use this function to compile menu items for surfaces and topographies
          //
          // return HTML

          var result = "";
          if (urls.hasOwnProperty('detail')) {
              result += `
                  <a href="${urls.detail}" class="dropdown-item">
                    {% fontawesome_icon 'folder-open-o' fixed=True  %} Details
                  </a>
              `
          }
          if (urls.hasOwnProperty('show_analyses')) {
              result += `
                  <a href="${urls.show_analyses}" class="dropdown-item">
                    {% fontawesome_icon 'area-chart' fixed=True %} Show analyses
                  </a>
              `
          }
          if (urls.hasOwnProperty('update')) {
              result += `
                  <div class="dropdown-divider"></div>
                  <a href="${urls.update}?redirect=${window.location}" class="dropdown-item">
                    {% fontawesome_icon 'edit' fixed=True %} Edit meta data
                  </a>
              `
          }
          if (urls.hasOwnProperty('add_topography')) {
              result += `
                  <a href="${urls.add_topography}" class="dropdown-item">
                    {% fontawesome_icon 'plus-square' fixed=True %} Add topography
                  </a>
              `
          }
          /** DOES NOT WORK YET
           * Make node expand when click on "Expand"
          if (node.hasOwnProperty('children')) {

              var expand_id = "expand-" + node.key;
              result += `
                  <div class="dropdown-divider"></div>
                  <a href="#" id="${expand_id}" class="dropdown-item">
                    {% fontawesome_icon 'chevron-down' %} Expand
                  </a>
              `;

              $("#"+expand_id).click(function () {
                  node.setExpanded(true)
              });
          }
          */
          if (urls.hasOwnProperty('delete')) {
              result += `
                  <div class="dropdown-divider"></div>
                  <a href="${urls.delete}" class="dropdown-item text-danger">
                    {% fontawesome_icon 'trash' fixed=True  %} Delete
                  </a>
              `
          }
          return result;
      }

      var newtree = $('#newtree').fancytree({
          extensions: ["glyph", "table", "filter"],
          glyph: {
              preset: "awesome4",
              map: {
                // Override distinct default icons here
                folder: "fa-folder",
                folderOpen: "fa-folder-open"
              }
          },
          table: {
		        checkboxColumnIdx: 0,    // render the checkboxes into the this column index (default: nodeColumnIdx)
		        indentation: 16,         // indent every node level by 16px
		        nodeColumnIdx: 1         // render node expander, icon, and title to this column (default: #0)
	        },
          filter: {
            autoApply: true,   // Re-apply last filter if lazy data is loaded
            autoExpand: true, // Expand all branches that contain matches while filtered
            counter: false,     // Show a badge with number of matching child nodes near parent icons
            fuzzy: false,      // Match single characters in order, e.g. 'fb' will match 'FooBar'
            hideExpandedCounter: true,  // Hide counter badge if parent is expanded
            hideExpanders: false,       // Hide expanders if all child nodes are hidden by filter
            highlight: false,   // Highlight matches by wrapping inside <mark> tags | we do this outself because of extra columns
            leavesOnly: false, // Match end nodes only
            nodata: true,      // Display a 'no data' status node if result is empty
            mode: "hide"
          },
          source: {
              url: "{% url 'manager:surface-search' %}",
              cache: false
          },
          //autoActivate: false,
          //titlesTabbable: false,
          focusOnSelect: false,
          scrollParent: $("#scrollParent"),
          checkbox: true,
          selectMode: 3, // 'multi-hier'
          init: function() {
            basket.update();
            summary_vm.update();
          },
          select: function(event, data) {
              var node = data.node;
              var is_selected = node.isSelected();

              if (is_selected) {
                   $.ajax({
                       type: "POST",
                       url: node.data.urls.select,
                       data: {
                           csrfmiddlewaretoken: "{{csrf_token}}"
                       },
                       success: function (data, textStatus, xhr) {
                           console.log("Selected: " + node.data.name + " " + node.key);
                           basket.update();
                       },
                       error: function (xhr, textStatus, errorThrown) {
                           console.error("Could not select: " + errorThrown + " " + xhr.status + " " + xhr.responseText);
                       }
                   });
              } else {
                  $.ajax({
                       type: "POST",
                       url: node.data.urls.unselect,
                       data: {
                           csrfmiddlewaretoken: "{{csrf_token}}"
                       },
                       success: function (data, textStatus, xhr) {
                           console.log("Unselected: " + node.data.name + " " + node.key);

                           basket.update();

                       },
                       error: function (xhr, textStatus, errorThrown) {
                           console.error("Could not unselect: " + errorThrown + " " + xhr.status + " " + xhr.responseText);
                       }
                   });
              }
          },
          renderColumns: function(event, data) {
              var node = data.node,

              $tdList = $(node.tr).find(">td");

              // (Index #0 is rendered by fancytree by adding the checkbox)
              // (Index #1 is rendered by fancytree)

              // Set rest from node data:
              var menu_html = `
              <div class="btn-group btn-group-sm pull-right dropdown">
                <button type="button" class="btn btn-default button-small" data-toggle="dropdown"
                        aria-haspopup="true" aria-expanded="false">
                  <i class="fa fa-bars fa-sm"></i>
                </button>
                <div class="dropdown-menu">
                  <h5 class="dropdown-header">
                  ${ node.key.includes('surface') ? 'Surface' : 'Topography' }
                  </h5>
                  <div class="dropdown-divider"></div>
                  ${ menu_items(node, node.data.urls) }
                </div>
              </div>
              `;

              $tdList
                .eq(2)
                  .html(menu_html);

              $tdList
                .eq(3)
                  .text(node.data.description);

              var tag_html = [];
              node.data.tags.forEach(function (tag) {
                 tag_html += "<span class='badge badge-success mr-1'>"+tag+"</span>"
              });
              $tdList
                .eq(4)
                  .html(tag_html);
              // Static markup (more efficiently defined as html row template):
              // $tdList.eq(3).html("<input type='input' value='" + "" + "'>");
              // ...
            },
      });

      Vue.component('basket-element', {
        props: ['node'],
        delimiters: ['[[', ']]'],
        template: `
               <span v-if="node.key.startsWith('surface')" class="badge badge-pill badge-primary mr-1">[[ node.title ]]
                    <span class="fa fa-close" v-on:click="handle_click"></span>
               </span>
               <span v-else class="badge badge-pill badge-secondary mr-1">[[ node.title ]]
                    <span class="fa fa-close" v-on:click="handle_click"></span>
               </span>
             `,
        methods: {
            handle_click: function (event) {
                // Clicking means "deselect"
                this.node.setSelected(false);
                basket.update();
            },
        }
      });

      function filter_items() {
          get_tree().filterNodes( function(node) {
            var category = $('#select-category-filter').val();
            var status = $('#select-sharing-status-filter').val();
            var term = $('#searchbar').val().toLocaleLowerCase();
            var data = node.data;

            return (data.name.toLocaleLowerCase().includes(term) || data.description.toLocaleLowerCase().includes(term)
                    || data.tags.some(function (tag) {return tag.includes(term)}))
                  && ((category==='all') || (node.data.category === category))
                  && ((status==='all') || (node.data.sharing_status === status));
         });


         // Highlight the search items in tree
         $("#newtree").unhighlight();
         $("#newtree").highlight($('#searchbar').val());

         summary_vm.update();
      }

      $("#select-category-filter").on('change', function() {
         filter_items();
      });

      $("#select-sharing-status-filter").on('change', function() {
         filter_items();
      });

      $("#searchbar").on('input', function (){
          filter_items();
      });

      $('#button_reset_filter').click( function(){
          $('#searchbar').val('');
          get_tree().clearFilter();
          filter_items();
      });


      // for each surface submit ajax call to insert a bootstrap card
      /**
      $(document).ready(function () {
        {% url 'manager:surface-card' as card_url %}
        {% for surface in surfaces %}
          // TODO disabled temporarily
          // submit_surface_card_ajax("{{ card_url }}", {{ surface.id }}, "{{ request.path }}");
        {% endfor %}
      });
      */
      // we don't want error messages if the page is left before everything is loaded
      install_handler_for_aborting_all_ajax_calls_on_page_leave();
  </script>

{% endblock javascript %}
