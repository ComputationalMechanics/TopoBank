
{% extends 'base.html' %}
{% load fontawesome %}
{% load surface_tags %}
{% load guardian_tags %}
{% load static i18n %}

{% block extra_css %}

  <!-- Include Fancytree skin  -->
  <!-- link href="{# static 'vendor/fancytree/skin-awesome/ui.fancytree.min.css' #}" rel="stylesheet" -->
  <!-- TODO Use CDN? -->
  <link href="https://unpkg.com/jquery.fancytree@2.33.0/dist/skin-awesome/ui.fancytree.min.css" rel="stylesheet"
        xmlns:vbind="http://www.w3.org/1999/xhtml" xmlns:vbind="http://www.w3.org/1999/xhtml"
        xmlns:v-bind="http://www.w3.org/1999/xhtml">

{% endblock extra_css %}

{% block breadcrumbs %}
  <li class="breadcrumb-item active" aria-current="page">
    Surfaces
  </li>
{% endblock breadcrumbs %}


{% block content %}


  {# full text search in names, descriptions, tags #}

  {% include "tabs.html" with active_tab="select" %}

  <div class="tab-content mt-2">
    <div class="tab-pane active">

      <form>
        <div class="form-row">

          <!--
          <div class="form-group col-md-4">
            <div class="input-group">
              <input id="searchbar" type="text" class="form-control" aria-label="Search"
                     placeholder="Filter by name, description, and tags..." autocomplete="off">
              <div class="input-group-append">
                <button class="btn btn-outline-secondary form-control" id="button_reset_filter" type="button">&times;</button>
              </div>
            </div>
          </div>
          -->
          {% if search_term %}
          <div class="form-group col-md-4">
            <a class="btn btn-warning form-control" href="{% url 'manager:surface-list' %}">Clear filter for <em>{{ search_term }}</em></a>
          </div>
          {% else %}
          <div class="form-group col-md-4">
            <button class="btn btn-outline-info form-control disabled" href="#">
              Not filtered for search term
            </button>
          </div>
          {% endif %}


          <div class="form-group col-md-2">
            <select class="form-control" id="select-category-filter">
              <option value="all" selected>All categories</option>
              <option value="exp">Experimental data only</option>
              <option value="sim">Simulated data only</option>
              <option value="dum">Dummy data only</option>
            </select>
          </div>

          <div class="form-group col-md-2">
            <select class="form-control" id="select-sharing-status-filter">
              <option value="all" selected>Own and shared surfaces</option>
              <option value="own">Only own surfaces</option>
              <option value="shared">Only surfaces shared with you</option>
            </select>
          </div>


          <div id="tree-selector" class="form-group btn-group btn-group-toggle col-md-2" data-toggle="buttons">
            <label class="btn btn-success active">
              <input type="radio" name="options" value="surface list" id="surface-list-radio-btn" autocomplete="off" checked>
              {% fontawesome_icon 'diamond' %} Surface list
            </label>
            <label class="btn btn-default">
                <input type="radio" name="options" value="tag tree" id="tag-tree-radio-btn" autocomplete="off">
                {% fontawesome_icon 'tag' %}Tag tree
            </label>
          </div>

          <div class="form-group col-md-2">
            <a class="btn btn-primary form-control" href="{% url 'manager:surface-create' %}">Create Surface</a>
          </div>

        </div>


      </form>


      <div id="search-results">
        <nav aria-label="Surfaces and Topographies for selection">
          <ul id="pagination" class="pagination">
            <li class="page-item" v-bind:class="{ disabled: prev_page_url == null }">
              <a class="page-link" id="prev_page_link" v-on:click="load_prev_page">Previous</a>
            </li>
            <li v-for="page_no in page_range">
              <a class="page-link" v-on:click="load_page(page_no)">[[ page_no ]]</a>
            </li>
            <!-- TODO insert links to individual pages -->
            <li class="page-item" v-bind:class="{ disabled: next_page_url == null }" >
              <a class="page-link" id="next_page_link" v-on:click="load_next_page">Next</a>
            </li>
          </ul>
        </nav>

        <div id="scrollParent">
          <table id="surface-tree" class="table table-condensed">
            <colgroup>
              <col width="40%"></col>
              <col width="45%"></col>
              <col width="15%"></col>
            </colgroup>
            <thead>
            <tr>
              <th scope="col">Name</th>
              <th scope="col">Description</th>
              <th scope="col">Actions</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
        <div>
          <span>Showing [[ num_items_on_current_page ]] [[ tree_mode_infos[tree_mode].element_kind ]] out of [[ num_items ]].
            [[ tree_mode_infos[tree_mode].hint ]]</span>
        </div>
      </div>
    </div>
  </div>

{% endblock content %}

{% block javascript %}

  <script src="https://unpkg.com/jquery-highlight@3.3.0/jquery.highlight.js"></script>
  <script src="https://unpkg.com/jquery.fancytree@2.33.0/dist/jquery.fancytree-all-deps.min.js"></script>
  <script src="https://unpkg.com/jquery.fancytree@2.33.0/dist/modules/jquery.fancytree.glyph.js"></script>
  <script src="https://unpkg.com/jquery.fancytree@2.33.0/dist/modules/jquery.fancytree.table.js"></script>
  <script src="https://unpkg.com/jquery.fancytree@2.33.0/dist/modules/jquery.fancytree.filter.js"></script>

  <script>

      //function get_tree() { // TODO remove
      //    return $("#result-tree").fancytree("getTree");
      //}

      function get_surface_tree() {
          return $("#surface-tree").fancytree("getTree");
      }

      function get_tag_tree() {
          return $("#tag-tree").fancytree("getTree");
      }


      function item_button_link_attributes(urls, urlname) {
          var attr = "";

          // console.log(urls, urlname);

          if (urls.hasOwnProperty(urlname)) {
              attr = `href="${urls[urlname]}"`;
          } else {
              attr = "href='#' disabled";
          }
          return attr;
      }

      function item_buttons(urls) {
          // node: tree node for which this function is called
          // urls: object with url names as keys and urls as values
          //
          // Use this function to compile buttons for surfaces and topographies in the result table
          //
          // return HTML
          var result = "";

          if (urls.hasOwnProperty('detail')) {
              result += `
                <a href="${urls['detail']}" class="btn btn-default" type="button">
                    Properties
                </a>
              `
          }
          if (urls.hasOwnProperty('analyze')) {
              result += `
                <a href="${urls['analyze']}" class="btn btn-default" type="button">
                    Analyze
                </a>
              `
          }

          return result;
      }

      var base_search_url = "{{ base_search_url_surface_tree | safe }}";

      $('#select-category-filter').change( function(){
        reload_tree();
      });

      $('#select-sharing-status-filter').change( function(){
        reload_tree();
      });

      $('#tree-selector :input').change( function() {
        var surface_list_label = $('#surface-list-radio-btn').parent('label');
        var tag_tree_label = $('#tag-tree-radio-btn').parent('label');

        switch (this.value) {
          case 'surface list':
            surface_list_label.addClass('btn-success').removeClass('btn-default');
            tag_tree_label.addClass('btn-default').removeClass('btn-success');
            break;
          case 'tag tree':
            tag_tree_label.addClass('btn-success').removeClass('btn-default');
            surface_list_label.addClass('btn-default').removeClass('btn-success');
            break;
        }
        reload_tree();
      });

      function reload_tree() {
        var search_term = "{{ search_term | default_if_none:'' | safe }}";
        var category = $('#select-category-filter option:selected').val();
        var sharing_status = $('#select-sharing-status-filter option:selected').val();
        var tree_mode = $('#tree-selector :checked').val();
        var base_search_url;
        console.log(search_term, category, sharing_status, "mode: ", tree_mode);
        if (tree_mode == "surface list") {
          base_search_url = "{{ base_search_url_surface_tree | safe }}";
        } else if (tree_mode == "tag tree") {
          base_search_url = "{{ base_search_url_tag_tree | safe }}";
        } else {
          console.warn(`Unknown tree mode '${tree_mode}' given. Cannot reload tree.`);
          return
        }
        search_results_vm.reload(base_search_url, tree_mode, search_term, category, sharing_status);
      }

      $(document).ready( function () {
        // TODO solve by event signal
        basket.unselect_handler = function unselect_nodes(key) {
              const tree = get_surface_tree();
              tree.findAll( function (node) {
                return node.key == key;
              }).forEach( function (node) {
                node.setSelected(false);
              })
        };
        reload_tree();
      });

      // we don't want error messages if the page is left before everything is loaded
      install_handler_for_aborting_all_ajax_calls_on_page_leave();
  </script>

  <script src="{% static 'js/trees.js' %}"></script>
{#  <script>#}
{#        $('#prev_page_btn').click( function(event) {#}
{#           console.log("prev page btn clicked");#}
{#           surface_tree_vm.load_prev_page(event);#}
{#        });#}
{##}
{#        $('#next_page_btn').click( function(event) {#}
{#          console.log("next page btn clicked");#}
{#          surface_tree_vm.load_next_page(event);#}
{#        });#}
{##}
{#  </script>#}

{% endblock javascript %}
